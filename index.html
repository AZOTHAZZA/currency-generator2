<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>通貨生成所 - PWA完全版</title>
<link rel="manifest" href="manifest.json">
<style>
body { font-family: sans-serif; padding: 10px; }
button { padding: 6px 12px; margin: 4px; border-radius: 6px; cursor: pointer; }
#balances div { margin-bottom: 6px; }
#chartContainer { max-width: 400px; margin-top: 20px; }
#aiSuggestion { margin-top: 10px; font-weight: bold; color: #007bff; }
</style>
</head>
<body>

<h1>通貨生成所 - 多通貨 & MetaMask対応</h1>

<div id="walletConnect">
  <button id="connectWalletBtn">ウォレット接続</button>
  <span id="walletAddress"></span>
</div>

<h2>残高</h2>
<div id="balances"></div>

<h2>操作</h2>
<select id="tokenSelect">
  <option value="JPY">日本円 (JPY)</option>
  <option value="USD">米ドル (USD)</option>
  <option value="EUR">ユーロ (EUR)</option>
  <option value="BTC">ビットコイン (BTC)</option>
  <option value="ETH">イーサリアム (ETH)</option>
  <option value="MATIC">MATIC (ガス)</option>
  <!-- ERC20例 -->
  <option value="0xYourERC20Address1">トークンA</option>
  <option value="0xYourERC20Address2">トークンB</option>
</select>
<input type="number" id="amountInput" placeholder="数量" step="any">
<button id="generateBtn">つくる</button>
<button id="reduceBtn">へらす</button>
<button id="sendBtn">わたす</button>

<div id="aiSuggestion">AI提案: まだありません</div>

<div id="chartContainer">
  <canvas id="balanceChart"></canvas>
</div>

<script src="https://cdn.jsdelivr.net/npm/ethers@6/dist/ethers.min.js"></script>
<script src="libs/chart.umd.min.js"></script>

<script>
// --- PWA用 Service Worker ---
if('serviceWorker' in navigator){
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('service-worker.js')
      .then(reg => console.log('Service Worker 登録成功:', reg.scope))
      .catch(err => console.log('Service Worker 登録失敗:', err));
  });
}

// --- ウォレット / MetaMask ---
let provider, signer, userAddress;
async function connectWallet() {
  if(!window.ethereum) { alert('MetaMaskをインストールしてください'); return; }
  provider = new ethers.BrowserProvider(window.ethereum);
  await provider.send("eth_requestAccounts", []);
  signer = await provider.getSigner();
  userAddress = await signer.getAddress();
  document.getElementById('walletAddress').textContent = userAddress;
  renderBalances();
}
document.getElementById('connectWalletBtn').addEventListener('click', connectWallet);

// --- 残高管理 ---
let balances = JSON.parse(localStorage.getItem('balances') || '{"JPY":100000,"USD":500,"EUR":200,"BTC":0.01,"ETH":0.05,"MATIC":10}');
let fullHistory = JSON.parse(localStorage.getItem('history') || []);
const balancesDiv = document.getElementById('balances');

function renderBalances(){
  balancesDiv.innerHTML = '';
  for(const [cur,val] of Object.entries(balances)){
    balancesDiv.innerHTML += `<div>${cur}: ${val}</div>`;
  }
}
renderBalances();

function saveState(){
  localStorage.setItem('balances', JSON.stringify(balances));
  localStorage.setItem('history', JSON.stringify(fullHistory));
}

// --- 操作 ---
async function performAction(action){
  const currency = document.getElementById('tokenSelect').value;
  let amount = parseFloat(document.getElementById('amountInput').value);
  if(isNaN(amount) || amount <= 0){ alert('正しい数量を入力'); return; }

  if(action==='つくる'){ balances[currency] = (balances[currency]||0)+amount; }
  if(action==='へらす'){ if(balances[currency]<amount) amount=balances[currency]; balances[currency]-=amount; }
  if(action==='わたす'){
    if(balances[currency]<amount){ alert('残高不足'); return; }
    balances[currency]-=amount;
    if(currency.startsWith('0x') && signer){
      const abi = ["function transfer(address to, uint256 amount)"];
      const contract = new ethers.Contract(currency, abi, signer);
      const decimals = 18;
      const tx = await contract.transfer(userAddress, ethers.parseUnits(amount.toString(),decimals));
      alert('送金Tx送信: '+tx.hash);
      await tx.wait();
      alert('送金完了');
    } else {
      alert(`${amount} ${currency} を送金（サンプル）`);
    }
  }

  const aiSuggested = Math.random()<0.5;
  fullHistory.push({action,currency,amount,ai:aiSuggested});
  updateAISuggestion();
  renderBalances();
  updateChart();
  saveState();
}

document.getElementById('generateBtn').addEventListener('click', ()=>performAction('つくる'));
document.getElementById('reduceBtn').addEventListener('click', ()=>performAction('へらす'));
document.getElementById('sendBtn').addEventListener('click', ()=>performAction('わたす'));

function updateAISuggestion(){
  const last = fullHistory[fullHistory.length-1];
  if(!last) return;
  const text = last.ai ? `AI提案: この操作は採用推奨 (${last.amount} ${last.currency})`
                       : `AI提案: この操作は慎重推奨 (${last.amount} ${last.currency})`;
  document.getElementById('aiSuggestion').textContent = text;
}

// --- Chart.js ---
let chartInstance;
function updateChart(){
  const ctx = document.getElementById('balanceChart').getContext('2d');
  if(chartInstance) chartInstance.destroy();
  chartInstance = new Chart(ctx,{
    type:'bar',
    data:{labels:Object.keys(balances), datasets:[{label:'残高', data:Object.values(balances), backgroundColor:['#ff4500','#1e90ff','#32cd32','#ffa500','#8a2be2','#00ced1','#ff69b4','#7fff00']}]},
    options:{responsive:true, plugins:{legend:{display:false}}}
  });
}
updateChart();
</script>
</body>
</html>